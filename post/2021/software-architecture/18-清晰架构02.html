<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>18.清晰架构02-超越同心圆分层 - P3的Blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="p3p3pp3"><meta name=description content="原文：https://herbertograca.com/2018/07/07/more-than-concentric-layers/ 这篇"><meta name=keywords content="P3,blog,coding"><meta name=baidu-site-verification content="code-rMlGvJbrZW"><meta name=google-site-verification content="iTJj3dp57yfylJL_-Z2_nwxz5Dz6jnf1xAwgKb6TS_g"><meta name=generator content="Hugo 0.107.0 with theme even"><link rel=canonical href=https://p3p3pp3.github.io/post/2021/software-architecture/18-%E6%B8%85%E6%99%B0%E6%9E%B6%E6%9E%8402.html><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<link href=/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="18.清晰架构02-超越同心圆分层"><meta property="og:description" content="原文：https://herbertograca.com/2018/07/07/more-than-concentric-layers/ 这篇"><meta property="og:type" content="article"><meta property="og:url" content="https://p3p3pp3.github.io/post/2021/software-architecture/18-%E6%B8%85%E6%99%B0%E6%9E%B6%E6%9E%8402.html"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-05-16T14:02:10+08:00"><meta property="article:modified_time" content="2021-05-16T14:02:10+08:00"><meta itemprop=name content="18.清晰架构02-超越同心圆分层"><meta itemprop=description content="原文：https://herbertograca.com/2018/07/07/more-than-concentric-layers/ 这篇"><meta itemprop=datePublished content="2021-05-16T14:02:10+08:00"><meta itemprop=dateModified content="2021-05-16T14:02:10+08:00"><meta itemprop=wordCount content="2563"><meta itemprop=keywords content="architecture,OO,DDD,"><meta name=twitter:card content="summary"><meta name=twitter:title content="18.清晰架构02-超越同心圆分层"><meta name=twitter:description content="原文：https://herbertograca.com/2018/07/07/more-than-concentric-layers/ 这篇"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>P3的Blog</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post.html><li class=mobile-menu-item>Archives</li></a><a href=/tags.html><li class=mobile-menu-item>Tags</li></a><a href=/categories.html><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>P3的Blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post.html>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags.html>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories.html>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>18.清晰架构02-超越同心圆分层</h1><div class=post-meta><span class=post-time>2021-05-16</span>
<span class=more-meta>约 2563 字</span>
<span class=more-meta>预计阅读 6 分钟</span>
<span id=busuanzi_container_page_pv class=more-meta><span id=busuanzi_value_page_pv><img src=/img/spinner.svg alt=spinner.svg></span> 次阅读</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#什么是共享内核>什么是共享内核？!</a></li><li><a href=#当语言不够用时>当语言不够用时…</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=post-content><p>原文：https://herbertograca.com/2018/07/07/more-than-concentric-layers/</p><p><em>这篇文章是
<a href=https://herbertograca.com/2017/07/03/the-software-architecture-chronicles/ target=_blank>软件架构编年史</a>(
<a href=https://www.jianshu.com/p/b477b2cc6cfa target=_blank>译</a>)的一部分，这部编年史由
<a href=https://herbertograca.com/category/development/series/software-architecture/ target=_blank>一系列关于软件架构的文章</a>组成。在这一系列文章中，我将写下我对软件架构的学习和思考，以及我是如何运用这些知识的。如果你阅读了这个系列中之前的文章，本篇文章的的内容将更有意义。</em></p><p>在
<a href=https://herbertograca.com/2017/11/16/explicit-architecture-01-ddd-hexagonal-onion-clean-cqrs-how-i-put-it-all-together/ target=_blank>我之前的这篇系列文章</a>(
<a href=https://www.jianshu.com/p/d3e8b9ac097b target=_blank>译</a>)中，我发表了一幅信息图，展示了用来理解代码单元类型之间联系的心智地图。</p><p>然而，我始终觉得有一部分内容并没有得到很好的体现，但我不知道应该如何更好地将它展示出来。这个部分就是共享内核。</p><p>而且，我还发现了一些新内容，在这篇博客中我将记录下所有的内容。</p><p>观察上一篇博客中发表的信息图，我们发现共享内核位于图的中心，看起来好像在领域层内部，叠在代表领域上下文的同心圆之上。</p><p><img src=18-%E6%B8%85%E6%99%B0%E6%9E%B6%E6%9E%8402.assets/4099-3d4a3ba2ae512c67.png alt=img></p><p>尽管将共享内核放在这个位置，但我要表达的并不是共享内核会依赖其余部分的代码，它也不是领域层内部的另一个层次。</p><h1 id=什么是共享内核>什么是共享内核？!</h1><p>共享内核由 <em>DDD 之父</em> Eric Evans 定义，它是多个限界上下文之间共享的代码，由开发团队决定：</p><blockquote><p>[&mldr;] 两个团队同意共享的领域模型的子集。当然，和模型子集一起共享还包括代码的子集，还有和这部分模型有关的数据库设计。这部分明确要共享的内容有着特殊的状态，而且在没有和其他团队达成一致的情况下不应该修改。</p><p><a href=http://ddd.fed.wiki.org/view/shared-kernel target=_blank>Shared Kernel</a>, Ward Cunningham 的 DDD wiki</p></blockquote><p>所以基本上，它可能是任何类型的代码：领域层代码、应用层代码、库，随便什么代码。</p><p><img src=18-%E6%B8%85%E6%99%B0%E6%9E%B6%E6%9E%8402.assets/4099-e9b61b95bcff7fda.jpg alt=img></p><p>然而，在我的这份心智地图里，我将它当做一些特定类型的代码的子集。在我的心智地图里，共享内核包含的是领域层和应用层的代码，这些代码会在限界上下文之间共享，让这些上下文可以互相通信。</p><p>这意味着，例如，一个或多个限界上下文触发的事件可以在其它的限界上下文里被监听到。需要和这些事件一起共享的还有它们用到的所有数据类型，例如：实体 ID、值对象、枚举，等等。事件不应该直接使用像实体这样的复杂对象，因为将它们序列化到队列中或是从队列中反序列化时都会遇到一些问题，所以共享的代码不应该太宽泛。</p><p>当然，如果我们手中的是一个由不同语言开发的微服务组成的多语言系统，共享内核必须是描述性的语言，格式是 json、xml、yaml 或者其它，这样所有的微服务都能理解。</p><p>因此，共享内核就完全和其余的代码以及组件完全解耦了。这样很好，因为这意味着尽管组件耦合了共享内核，但组件之间不再耦合。共享代码可以被清晰地识别出来，并轻松地提取到一个独立的库中。</p><p>如果我们决定将一个限界上下文从单体中分离出来并提取成一个微服务，这也会很方便。我对共享代码了然于心，可以轻松地将共享内核提取到一个库中。而这个库即可以安装到单体中，也可以安装到微服务中。</p><p>所以回顾一下，在我的心智地图中，应用核心依赖共享内核，共享内核包括了在限界上下文之间共享的领域层和应用层代码。</p><h1 id=当语言不够用时>当语言不够用时…</h1><p>这样，我们得到了包含同心圆层次的应用代码，而应用核心依赖着支撑所有这些代码的共享内核。</p><p>我们还可以说所有代码都依赖它们所使用的编程语言，但我们对这样显而易见的事实熟视无睹。</p><p>然而我要抛出这个事实，原因是还有一个问题“当语言结构不够用时我们该怎么办？！”。显然我们会自己创造语言结构，来填补这些语言的瑕疵。随后我会提出下一个重要的问题“我们如何传递这些代码之所以存在地背后原理？我们把它放在哪里？我们如何清晰地表达使用它的时机？使用方法？”</p><p>我见过做法的是，我自己也是这样做的，将代码放在一个名为 Utils 或 Commons 的包里。但它最终会变成一个筐子，当我们不知道代码该放在哪儿时，就会一股脑儿全扔进这个筐子里！不同类型的代码，不同用途的代码，还有不同用法（包装在适配器里使用，或是直接使用&mldr;）的代码最后都被扔在这里，这个包没有概念性的含义，没有一致性，没有内聚性，一点也不明确，到处充斥着歧义。</p><p>我想抛弃 Utils 和 Commons 包！</p><p>每一个包都必须在概念上内聚！何时使用包以及如何使用包必须是明确的！不能有任何歧义！</p><p>因此，举个例子，如果我们的应用有一些特殊的和 CLI 交互的方式，我们可以把相关代码放在“Acme/App/Infrastructure/Cli/SpecialCli”命名空间下，而不是放在“Acme/Util/SpecialCli”命名空间下。前一个名字告诉我们这个包和 CLI 有关，它是“Acme”公司的应用“App”的“Infrastructure”（基础设施）的一部分。既然它是应用基础设施的一部分，也就是说应用核心中还应该有一个端口，它必须遵循这个端口。</p><p>另一种情况是，如果我们发现包是这种语言自己应该/能够具备的一些东西，我们可以把它放在可以体现出这层含义的命名空间之下，比如“Acme/PhpExtension/SpecialCli”。这个名字告诉我们这个包应该被看作是语言自身的一部分，因此其中的代码应该被其它代码像语言结构一样直接使用。但是，如果其它公司依赖这个包时，显然不会傻傻地直接依赖它，而是为它创建端口/适配器，这是更妥善的处理方法，这样他们可以换掉它。然而，如果这个包是我们自己来负责，我们就可以决定把它当成语言的一部分来对待，因为出现寻找替代品的风险的几率要小得多。这里总有一些权衡。</p><p>另一个我们可以认为是语言的一部分的例子是 PHP 中的 UUID。我可以不把它想成是语言的一部分，因为每隔一段时间就会有一个新版本并造成一些维护的负担；但它却是一个通用、广泛和一致的概念，足以成为语言的一部分。</p><p>所以，为什么不创建一个 UUID 的实现，把它当成 PHP 自身的一部分来使用呢？就像我们使用 DateTime 对象一样？只要实现还在我们的掌控之中，我觉得没有什么坏处。</p><p>那么 Doctrine Query Language (DQL) 呢？ （Doctrine 是 Hibernate 在 PHP 中的移植） 我们能把 DQL 当成 SQL、Elasticsearch QL 或 Mongo QL 吗？</p><h1 id=总结>总结</h1><p>所以总结一下，我在宏观层面发现了四种主要的代码类型，而且我认为在代码组织中将它们清晰地展现出来，是我们避免最终形成大泥球的关键。</p><p><img src=18-%E6%B8%85%E6%99%B0%E6%9E%B6%E6%9E%8402.assets/4099-7d9798671c6a4b74.png alt=img></p><p>于我而言，不能质疑的真相是<strong>架构就在那里，唯一的问题是：它在不在我们掌控之中？！</strong>。</p><p>因此，让我们<strong>清晰地组织好代码，来帮助我们表达架构</strong>，全盘或者部分遵循我的心智地图，遵循你自己的心智地图，或者遵循其他人的心智地图都可以，但是请使用一致的推理思路来组织代码，让项目可以使用结构和代码组织来清晰地表达架构。</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>p3p3pp3</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-05-16</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/architecture.html>architecture</a>
<a href=/tags/oo.html>OO</a>
<a href=/tags/ddd.html>DDD</a></div><nav class=post-nav><a class=prev href=/post/2021/software-architecture/19-%E6%B8%85%E6%99%B0%E6%9E%B6%E6%9E%8403.html><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">19.清晰架构03-在代码中展现架构和领域</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/2021/software-architecture/17-%E6%B8%85%E6%99%B0%E6%9E%B6%E6%9E%8401.html><span class="next-text nav-default">17.清晰架构01-融合 DDD、洋葱架构、整洁架构、CQRS.</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="p3sblog",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=https://p3p3pp3.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量 <span id=busuanzi_value_site_pv><img src=/img/spinner.svg alt=spinner.svg></span> 次</span>
<span class=division>|</span>
<span id=busuanzi_container_site_uv>本站总访客数 <span id=busuanzi_value_site_uv><img src=/img/spinner.svg alt=spinner.svg></span> 人</span></div><span class=copyright-year>&copy;
2017 -
2022<span class=heart><i class="iconfont icon-heart"></i></span><span>p3p3pp3</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script>
<script type=text/javascript>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"ams"}}</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-134997356-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script id=baidu_push>(function(){if(window.location.hostname==="localhost")return;var t,n,e=document.createElement("script");e.async=!0,n=window.location.protocol.split(":")[0],n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>